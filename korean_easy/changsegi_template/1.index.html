<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì°½ì„¸ê¸° 1ì¥ | Stable Chapter v1.1</title>
<style>
  :root{
    --text:#222; --line:#e6e6e6; --panel:#fafafa;
    --container:1200px;         /* .bar .page .wrap ê³µí†µ í­ */
    --pad:20px;
    --archive-width:clamp(360px,30vw,480px);
  }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font-family:"Malgun Gothic",system-ui,sans-serif;-webkit-user-select:none;user-select:none}
  .top-space{height:48px}

  /* ì¢Œìš° ê°€ì¥ìë¦¬ ì •ë ¬ í†µì¼ */
  .bar,.page{max-width:var(--container);padding:0 var(--pad);margin:0 auto}
  .wrap{max-width:var(--container);margin:0 auto 90px;display:grid;grid-template-columns:minmax(0,1fr) var(--archive-width);gap:24px;align-items:flex-start}
  @media (max-width:960px){.wrap{grid-template-columns:1fr}}

  .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .left,.right{display:flex;align-items:center;gap:8px}
  .icon{font-size:18px}

  .book{width:105px;padding:6px 8px;border:1px solid #ccc;border-radius:4px}
  .chap{width:30px;padding:6px 8px;border:1px solid #ccc;border-radius:4px;text-align:center}
  .search{width:120px;padding:6px 8px;border:1px solid #ccc;border-radius:4px}
  .search2{width:134px;padding:6px 8px;border:1px solid #ccc;border-radius:4px}
  .icon.search-icon{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;background:#222;color:#fff}
  .icon.search-icon svg{width:18px;height:18px;display:block}
  .divider{border:0;border-top:1px solid var(--line);margin:12px 0 18px}

  .title-band{display:flex;justify-content:center;margin-bottom:14px}
  .title-pack{display:inline-block;text-align:center}
  .title-pack h1{margin:4px 0 16px;font-size:30px;font-weight:800;line-height:1.15}

  /* ì œëª© ì•„ë˜ í™”ì‚´í‘œ(ë°•ìŠ¤ ì œê±°) */
  .ch-arrows{display:flex;justify-content:center;gap:16px;margin-top:4px}
  .ch-arrows .arrow{
    width:auto;height:auto;border:none;background:transparent;box-shadow:none;
    color:#444;text-decoration:none;font-size:28px;line-height:1;padding:0 6px;cursor:pointer
  }
  .ch-arrows .arrow:hover{transform:translateY(-1px)}
  .ch-arrows .arrow:focus{outline:2px solid #a9c7ff;border-radius:6px}
  .ch-arrows .arrow.disabled{opacity:.35;pointer-events:none}

  .version{display:block;margin:2px 0 12px;text-align:left}
  .tip{position:relative;display:inline-block;cursor:help;font-weight:700;border:1px solid #bbb;border-radius:50%;width:18px;height:18px;line-height:16px;text-align:center;font-size:12px;color:#555}
  .tip:hover::after{content:attr(data-help);white-space:pre;position:absolute;left:22px;top:-4px;background:#333;color:#fff;padding:8px 10px;border-radius:6px;font-size:12px;z-index:10}

  .panel{background:var(--panel);border:1px solid #d8d8d8;border-radius:8px;overflow:hidden}
  .panel .ph{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #eaeaea;background:#f6f6f6;font-weight:700;font-size:13px}
  .panel .ph .btns button{border:none;background:transparent;cursor:pointer;font-size:12px;color:#666;padding:2px 4px}
  .panel .body{padding:10px;min-height:100px}
  .panel .body[contenteditable="true"]{outline:none}

  #archive{height:180px}
  #libre{min-height:280px}

  .placeholder{padding:12px;border:1px dashed #cfcfcf;border-radius:8px;color:#888;background:#fcfcfc}

  /* MENU */
  .menu{position:relative}
  .menu-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #ddd;border-radius:8px;background:#fff;color:#444;cursor:pointer;font-size:18px}
  .menu.open .menu-btn{background:#111;color:#fff;border-color:#111}
  .menu-list{position:absolute;right:0;top:38px;min-width:240px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.12);padding:8px;display:none;z-index:1000}
  .menu.open .menu-list{display:block}
  .menu-group{padding:6px 6px 4px;font-size:12px;color:#6b7280}
  .menu-item{display:flex;align-items:center;gap:8px;width:100%;margin:2px 0;padding:9px 10px;border-radius:8px;border:0;background:#fff;color:#111;text-align:left;cursor:pointer;font-size:14px;text-decoration:none}
  .menu-item:hover{background:#f3f4f6}
  .menu-sep{height:1px;background:#eee;margin:6px 4px}

  // ko
menu:{ jump:'ë°”ë¡œê°€ê¸°', home:'í™ˆìœ¼ë¡œ', tools:'ë„êµ¬', help:'ë„ì›€ë§',
       print:'ì¸ì‡„', download:'ë‹¤ìš´ë¡œë“œ(.txt)', guide:'ì‚¬ìš©ì„¤ëª…ì„œ' },

// zh
menu:{ jump:'å¿«æ·', home:'è¿”å›ä¸»é¡µ', tools:'å·¥å…·', help:'å¸®åŠ©',
       print:'æ‰“å°', download:'ä¸‹è½½(.txt)', guide:'ä½¿ç”¨è¯´æ˜' },

// es
menu:{ jump:'Accesos', home:'Inicio', tools:'Herramientas', help:'Ayuda',
       print:'Imprimir', download:'Descargar (.txt)', guide:'GuÃ­a de uso' },

// en
menu:{ jump:'Shortcuts', home:'Home', tools:'Tools', help:'Help',
       print:'Print', download:'Download (.txt)', guide:'User Guide' },

  /* ë§ˆì´í¬ FAB + ë§í’ì„  */
  .mic{position:fixed;right:24px;bottom:24px;width:54px;height:54px;border:none;border-radius:50%;background:#2f2f2f;color:#fff;font-size:24px;box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer;z-index:999}
  .bubble{position:fixed;right:90px;bottom:32px;max-width:320px;background:#111;color:#fff;border-radius:12px;padding:8px 10px;font-size:13px;line-height:1.4;display:none;z-index:2000;pointer-events:none}
  .bubble.show,.bubble.live{display:block !important}
</style>
</head>
<body oncontextmenu="return false" ondragstart="return false">
<div class="top-space"></div>

<div class="bar">
  <div class="topbar">
    <div class="left">
      <span class="icon">ğŸ“–</span>
      <input class="book" type="text" value="ì°½ì„¸ê¸°" readonly />
      <input class="chap" type="text" value="1" readonly />
    </div>
    <div class="right">
      <span class="icon search-icon" aria-hidden="true" title="ë³¸ë¬¸ ê²€ìƒ‰">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
        </svg>
      </span>
      <input class="search"  type="text" placeholder="ë³¸ë¬¸ ê²€ìƒ‰" />
      <input class="search2" type="text" placeholder="ì˜ˆ) ì‹­ìê°€ / ë¶€í™œ" />
      <div class="menu" id="globalMenu"></div>
    </div>
  </div>
  <hr class="divider" />
</div>

<div class="page">
  <div class="title-band">
    <div class="title-pack">
      <h1 id="chapTitle">ì°½ì„¸ê¸° 1ì¥</h1>
      <div class="ch-arrows" role="navigation" aria-label="ì¥ ì´ë™">
        <a id="prev" class="arrow" href="#" aria-label="ì´ì „ ì¥" title="ì´ì „ ì¥">â€¹</a>
        <a id="next" class="arrow" href="#" aria-label="ë‹¤ìŒ ì¥" title="ë‹¤ìŒ ì¥">â€º</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="col-left">
      <div class="version">ì‰¬ìš´ì„±ê²½ <span class="tip" id="tip" data-help="ë§ì”€: ë‚˜ì¤‘ì— ì±„ì›€&#10;í•„ì‚¬ì¹¸: ë¶™ì—¬ë„£ê¸° ë°©ì§€&#10;ë³´ì¡°ì¹¸: ììœ í¸ì§‘, â–²â–¼ë¡œ ë†’ì´ ì¡°ì ˆ">?</span></div>
      <div id="verses" class="placeholder">
        â€» ì´ ì¥ì˜ ë§ì”€ì€ ì•„ì§ ë¹„ì›Œë‘ì—ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ê° ì ˆì„ ì¶”ê°€í•˜ê³  í•„ì‚¬ì¹¸ì„ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”.
      </div>
    </div>

    <aside class="col-right">
      <section id="archive" class="panel">
        <div class="ph" id="archTitle">ì•„ì¹´ì´ë¸Œ
          <div class="btns">
            <button type="button" data-delta="-40" title="ìœ„ë¡œ ì¤„ì´ê¸°">â–²</button>
            <button type="button" data-delta="40"  title="ì•„ë˜ë¡œ ëŠ˜ë¦¬ê¸°">â–¼</button>
          </div>
        </div>
        <div class="body" id="archiveBody" contenteditable="true" spellcheck="false"></div>
      </section>
      <section id="libre" class="panel">
        <div class="ph" id="libreTitle">ë¦¬ë¸Œë ˆ(ììœ  ë©”ëª¨)</div>
        <div class="body" id="libreBody" contenteditable="true" spellcheck="false"></div>
      </section>
    </aside>
  </div>
</div>

<button class="mic" id="micBtn" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
<div class="bubble" id="bubble">ë§ˆì´í¬ë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>

<script>
(() => {
  const $ = s => document.querySelector(s);

  /* ë¶™ì—¬ë„£ê¸° ë°©ì§€ */
  document.addEventListener('paste', (e) => {
    const t = e.target;
    if (t && (t.tagName === 'TEXTAREA' || t.tagName === 'INPUT' || t.isContentEditable)) {
      e.preventDefault();
    }
  });

  /* ì•„ì¹´ì´ë¸Œ ë†’ì´ ì¡°ì ˆ */
  const arch = document.getElementById('archive');
  if (arch) {
    arch.querySelectorAll('.btns button').forEach((b) => {
      b.addEventListener('click', () => {
        const d = parseInt(b.dataset.delta || '0', 10);
        const h = Math.max(80, arch.offsetHeight + d);
        arch.style.height = h + 'px';
      });
    });
  }

  /* ê²½ë¡œ íŒŒì‹± & ì–¸ì–´/ë²„ì „ ê°ì§€ */
  const pad3 = n => String(n).padStart(3,'0');
  const path = location.pathname.replace(/\/+$/,'');
  const parts = path.split('/').filter(Boolean);
  const folder = parts[parts.length-1] || '';     // e.g. changsegi001 / chuangshiji001 / genesis001
  const versionDir = parts[parts.length-2] || ''; // e.g. korean_easy / chinese_cuv / ...
  const m = folder.match(/^([a-z\-]+)(\d{3})$/i) || [];
  const prefix = m[1] || 'changsegi';
  const num    = m[2] ? parseInt(m[2],10) : 1;

  const VERSION_TO_LANG = { korean_easy:'ko', chinese_cuv:'zh', spanish_nvi:'es', english_niv:'en' };
  const ALIAS_TO_CANON  = { changsegi:'genesis', chuangshiji:'genesis', genesis:'genesis' };
  const LANG  = VERSION_TO_LANG[versionDir] || 'ko';
  const CANON = ALIAS_TO_CANON[prefix] || prefix;

  const I18N = {
    ko:{
      titles:{genesis:'ì°½ì„¸ê¸°'}, chapter:(n)=>`${n}ì¥`,
      versionLabel:'ì‰¬ìš´ì„±ê²½',
      placeholder:'â€» ì´ ì¥ì˜ ë§ì”€ì€ ì•„ì§ ë¹„ì›Œë‘ì—ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ê° ì ˆì„ ì¶”ê°€í•˜ê³  í•„ì‚¬ì¹¸ì„ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”.',
      tip:'ë§ì”€: ë‚˜ì¤‘ì— ì±„ì›€\ní•„ì‚¬ì¹¸: ë¶™ì—¬ë„£ê¸° ë°©ì§€\në³´ì¡°ì¹¸: ììœ í¸ì§‘, â–²â–¼ë¡œ ë†’ì´ ì¡°ì ˆ',
      archive:'ì•„ì¹´ì´ë¸Œ', libre:'ë¦¬ë¸Œë ˆ(ììœ  ë©”ëª¨)',
      search1:'ë³¸ë¬¸ ê²€ìƒ‰', search2:'ì˜ˆ) ì‹­ìê°€ / ë¶€í™œ',
      menu:{jump:'ë°”ë¡œê°€ê¸°', tools:'ë„êµ¬', help:'ë„ì›€ë§',
            toVersion:'ë²„ì „ ëª©ì°¨ë¡œ', toLang:'ì–¸ì–´ í™ˆìœ¼ë¡œ', toRoot:'ì „ì²´ í™ˆìœ¼ë¡œ',
            print:'ì¸ì‡„', download:'ë‹¤ìš´ë¡œë“œ(.txt)', guide:'ì‚¬ìš©ì„¤ëª…ì„œ'},
      mic:{no:'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', click:'í•„ì‚¬ì¹¸/ë©”ëª¨ì¹¸ì„ í´ë¦­í•œ ë’¤ ë§ˆì´í¬ë¥¼ ëˆ„ë¥´ì„¸ìš”.', rec:'ë…¹ìŒ ì¤‘â€¦'},
      export:{arch:'ì•„ì¹´ì´ë¸Œ', libre:'ë¦¬ë¸Œë ˆ(ììœ  ë©”ëª¨)', text:'í…ìŠ¤íŠ¸'}
    },
    zh:{
      titles:{genesis:'åˆ›ä¸–è®°'}, chapter:(n)=>`ç¬¬${n}ç« `,
      versionLabel:'å’Œåˆæœ¬ï¼ˆCUVï¼‰',
      placeholder:'â€» æœ¬ç« ç»æ–‡æš‚ä¸ºç©ºç™½ã€‚ç¨åè¯·æ·»åŠ å„èŠ‚å¹¶ç²˜è´´èªŠå†™åŒºã€‚',
      tip:'ç»æ–‡ï¼šç¨åå¡«å†™\nèªŠå†™åŒºï¼šç¦æ­¢ç²˜è´´\nä¾§æ ï¼šè‡ªç”±ç¼–è¾‘ï¼Œå¯ç”¨ â–²â–¼ è°ƒæ•´é«˜åº¦',
      archive:'å­˜æ¡£', libre:'éšè®°',
      search1:'æ­£æ–‡æœç´¢', search2:'ä¾‹ï¼šåå­—æ¶ / å¤æ´»',
      menu:{jump:'å¿«æ·', tools:'å·¥å…·', help:'å¸®åŠ©',
            toVersion:'è¿”å›ç‰ˆæœ¬ç›®å½•', toLang:'è¿”å›è¯­è¨€ä¸»é¡µ', toRoot:'è¿”å›æ€»ä¸»é¡µ',
            print:'æ‰“å°', download:'ä¸‹è½½(.txt)', guide:'ä½¿ç”¨è¯´æ˜'},
      mic:{no:'æ­¤æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚', click:'è¯·å…ˆç‚¹å‡»èªŠå†™/å¤‡æ³¨åŒºåŸŸå†æŒ‰éº¦å…‹é£ã€‚', rec:'å½•éŸ³ä¸­â€¦'},
      export:{arch:'å­˜æ¡£', libre:'éšè®°', text:'æ–‡æœ¬'}
    },
    es:{
      titles:{genesis:'GÃ©nesis'}, chapter:(n)=>`${n}`,
      versionLabel:'NVI',
      placeholder:'â€» Este capÃ­tulo estÃ¡ vacÃ­o. Luego agrega los versÃ­culos y pega el Ã¡rea de copia.',
      tip:'Texto: se completarÃ¡ despuÃ©s\nÃrea de copia: pegar deshabilitado\nPaneles: ediciÃ³n libre, â–²â–¼ para altura',
      archive:'Archivo', libre:'Libre (Notas)',
      search1:'Buscar en texto', search2:'Ej.) cruz / resurrecciÃ³n',
      menu:{jump:'Accesos', tools:'Herramientas', help:'Ayuda',
            toVersion:'Ir al Ã­ndice de versiÃ³n', toLang:'Ir al inicio del idioma', toRoot:'Ir a inicio general',
            print:'Imprimir', download:'Descargar (.txt)', guide:'GuÃ­a de uso'},
      mic:{no:'Este navegador no soporta reconocimiento de voz.', click:'Haz click en un Ã¡rea de escritura y luego el micrÃ³fono.', rec:'Grabandoâ€¦'},
      export:{arch:'Archivo', libre:'Libre', text:'Texto'}
    },
    en:{
      titles:{genesis:'Genesis'}, chapter:(n)=>`${n}`,
      versionLabel:'NIV',
      placeholder:'â€» This chapter is empty for now. Later add verses and paste the writing fields.',
      tip:'Verses: to be filled later\nWriting area: paste disabled\nSide panels: free edit, â–²â–¼ to resize',
      archive:'Archive', libre:'Libre (Notes)',
      search1:'Find in text', search2:'e.g., cross / resurrection',
      menu:{jump:'Shortcuts', tools:'Tools', help:'Help',
            toVersion:'Open version index', toLang:'Open language home', toRoot:'Open global home',
            print:'Print', download:'Download (.txt)', guide:'User Guide'},
      mic:{no:'Speech recognition not supported.', click:'Click a writing/memo area, then press the mic.', rec:'Listeningâ€¦'},
      export:{arch:'Archive', libre:'Libre (Notes)', text:'Text'}
    }
  };

  const L = I18N[LANG] || I18N.ko;
  const bookName = (L.titles[CANON] || CANON);
  const chapLabel = L.chapter(num);

  /* ì œëª©/ë¼ë²¨/í”Œë ˆì´ìŠ¤í™€ë” ë¡œì»¬ë¼ì´ì¦ˆ */
  $('#chapTitle').textContent = LANG==='ko' ? `${bookName} ${chapLabel}` :
                               LANG==='zh' ? `${bookName} ${chapLabel}` :
                                             `${bookName} ${chapLabel}`;
  const bookInput = document.querySelector('.book');
  const chapInput = document.querySelector('.chap');
  if (bookInput) bookInput.value = bookName;
  if (chapInput) chapInput.value = String(num);

  document.querySelector('.version').firstChild.nodeValue = (L.versionLabel + ' ');
  const tip = document.getElementById('tip'); if (tip) tip.setAttribute('data-help', L.tip);
  document.getElementById('verses').textContent = L.placeholder;
  document.getElementById('archTitle').firstChild.nodeValue = L.archive + ' ';
  document.getElementById('libreTitle').textContent = L.libre;
  document.querySelector('.search').placeholder = L.search1;
  document.querySelector('.search2').placeholder = L.search2;

  /* ì´ì „/ë‹¤ìŒ(í´ë”í˜• ë§í¬) */
  const prevEl = $('#prev'), nextEl = $('#next');
  if (prevEl){
    if (num > 1){ prevEl.href = `../${prefix}${pad3(num-1)}/`; }
    else { prevEl.classList.add('disabled'); prevEl.removeAttribute('href'); }
  }
  if (nextEl){ nextEl.href = `../${prefix}${pad3(num+1)}/`; }

/* ===== ë©”ë‰´ ìƒì„±: í™ˆ/ì¸ì‡„/ë‹¤ìš´ë¡œë“œ/ì„¤ëª…ì„œ ===== */
(function buildMenu(){
  const path = location.pathname.replace(/\/+$/,'');
  const parts = path.split('/').filter(Boolean);
  const versionDir = parts[parts.length-2] || '';
  const root = '/'+parts.slice(0, parts.length-2).join('/')+'/'; // /faith-scripture/
  const langMap = {korean_easy:'ko', chinese_cuv:'zh', spanish_nvi:'es', english_niv:'en'};
  const langHome = root + (langMap[versionDir] || 'ko') + '/';
  const guideUrl = root + '#guide';

  const menu = document.getElementById('globalMenu');
  if (!menu) return;

  menu.innerHTML = `
    <button class="menu-btn" aria-label="ë©”ë‰´" title="ë©”ë‰´">â‹¯</button>
    <div class="menu-list" role="menu" aria-label="Global menu">
      <div class="menu-group">${L.menu.jump}</div>
      <a class="menu-item" href="${langHome}" role="menuitem">${L.menu.home}</a>

      <div class="menu-sep"></div>
      <div class="menu-group">${L.menu.tools}</div>
      <button class="menu-item" data-action="print" role="menuitem">${L.menu.print}</button>
      <button class="menu-item" data-action="download" role="menuitem">${L.menu.download}</button>

      <div class="menu-sep"></div>
      <div class="menu-group">${L.menu.help}</div>
      <a class="menu-item" href="${guideUrl}" role="menuitem">${L.menu.guide}</a>
    </div>
  `;

  const btn  = menu.querySelector('.menu-btn');
  const list = menu.querySelector('.menu-list');
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
  document.addEventListener('click', ()=> menu.classList.remove('open'));

  // ë„êµ¬ ë™ì‘
  list.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-action]');
    if (!t) return;
    if (t.dataset.action === 'print') {
      window.print();
    } else if (t.dataset.action === 'download') {
      const folder = parts[parts.length-1] || '';
      const title = document.getElementById('chapTitle')?.textContent?.trim() || folder;
      const arch  = document.getElementById('archiveBody')?.innerText || '';
      const libre = document.getElementById('libreBody')?.innerText || '';
      const tas   = Array.from(document.querySelectorAll('textarea'))
                    .map((ta,i)=>`[Textarea ${i+1}] \n${ta.value||''}`).join('\n\n');
      const blob = new Blob([
        [`# ${title}`, '', 
         arch ? `## ${L.export.arch}\n${arch}` : '',
         libre ? `## ${L.export.libre}\n${libre}` : '',
         tas ? `## ${L.export.text}\n${tas}` : ''
        ].filter(Boolean).join('\n\n')
      ], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${folder}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    menu.classList.remove('open');
  });
})();

  /* ìë™ ì €ì¥/ë³µì› */
  const key = (k) => `fs:v1:${versionDir}:${folder}:${k}`;
  ['archiveBody','libreBody'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const saved = localStorage.getItem(key(id));
    if (saved !== null) el.innerHTML = saved;
    el.addEventListener('input', () => localStorage.setItem(key(id), el.innerHTML));
  });
  (function bindTA(root=document){
    root.querySelectorAll('textarea').forEach((ta,i)=>{
      const k = key('v' + (ta.dataset.verse || (i+1)));
      const saved = localStorage.getItem(k);
      if (saved !== null) ta.value = saved;
      ta.addEventListener('input', () => localStorage.setItem(k, ta.value));
    });
  })();

  /* ë§ˆì´í¬ */
  const micBtn = $('#micBtn'), bubble = $('#bubble');
  function toast(msg){ if(!bubble) return alert(msg); bubble.textContent=msg; bubble.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>bubble.classList.remove('show'),1600); }
  function listening(on){ if(!bubble) return; bubble.textContent = L.mic.rec; bubble.classList.toggle('live',on); bubble.classList.toggle('show',on); }
  if (micBtn){
    micBtn.addEventListener('click', ()=>{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR){ toast(L.mic.no); return; }
      const rec = new SR();
      const langOf = {korean_easy:'ko-KR', chinese_cuv:'zh-CN', spanish_nvi:'es-ES', english_niv:'en-US'};
      rec.lang = langOf[versionDir] || 'ko-KR';
      rec.interimResults=false; rec.continuous=false; rec.maxAlternatives=1;
      rec.onstart = ()=> listening(true);
      rec.onend   = ()=> listening(false);
      rec.onerror = e => toast('ì˜¤ë¥˜: ' + (e.error||'unknown'));
      rec.onresult= e => {
        const t = document.activeElement;
        const txt = e.results[0][0].transcript;
        if (t && t.tagName==='TEXTAREA'){
          const needsSpace = t.value && !/\s$/.test(t.value);
          const pos = t.selectionStart ?? t.value.length;
          t.setRangeText((needsSpace?' ':'')+txt, pos, pos, 'end');
          t.dispatchEvent(new Event('input'));
        } else if (t && t.isContentEditable){
          document.execCommand('insertText', false, txt+' ');
        } else {
          toast(L.mic.click);
        }
      };
      try{ rec.start(); }catch(_){}
    });
  }

  /* ì£¼ì†Œì°½ ì •ë¦¬: /index.html â†’ / */
  (function(){
    var p = location.pathname;
    if (p.endsWith('/index.html')) {
      var clean = p.slice(0, -'index.html'.length);
      history.replaceState(null, '', clean + location.search + location.hash);
    }
  })();
})();
</script>
</body>
</html>
